name: helm-postgresql

on:
  workflow_dispatch:

env:
  K8S_NAMESPACE: helm

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [ 21 ]
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{matrix.java-version}}
          check-latest: true
          cache: 'maven'

      #- name: Install jbang
      #  run: |
      #    curl -Ls https://sh.jbang.dev | bash -s - app setup

      - name: Kubernetes KinD Cluster
        uses: container-tools/kind-action@v1
        with:
          version: v0.11.1
          registry: true

      - name: Install helm 4
        run: |
          #sudo apt remove helm
          which helm
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4
          chmod 700 get_helm.sh
          ./get_helm.sh
          helm version

      - name: Install postgresql helm chart
        run: |
          CHARTS=$(pwd)/.github/charts
          kubectl create namespace $K8S_NAMESPACE
          
          RELEASE_NAME=postgresql-db
          MAX_ATTEMPTS=20
          SLEEP_TIME=5
          
          helm install $RELEASE_NAME $CHARTS/postgresql-18.2.4 -n $K8S_NAMESPACE
          helm status $RELEASE_NAME -n $K8S_NAMESPACE
  
          echo "Waiting for Helm release '$RELEASE_NAME' to be 'deployed'..."
          
          for ((i=1; i<=MAX_ATTEMPTS; i++)); do
            # -o json allows us to parse the status accurately with jq
            STATUS=$(helm status $RELEASE_NAME -n $K8S_NAMESPACE -o json | jq -r '.info.status')
             
            if [ "$STATUS" == "deployed" ]; then
              echo "âœ… Success: Release is deployed."
              exit 0
            fi
   
            echo "Attempt $i/$MAX_ATTEMPTS: Current status is '$STATUS'. Waiting..."
            sleep $SLEEP_TIME
          done
          
          echo "::error::Timed out waiting for Helm release to deploy."
          helm status $RELEASE_NAME -n $K8S_NAMESPACE
          kubectl get events -n $K8S_NAMESPACE --sort-by='.lastTimestamp' | tail -n 10
          exit 1

      - name: Check postgresql pod
        run: |
          kubectl -n $K8S_NAMESPACE get pods
          kubectl -n $K8S_NAMESPACE describe pod/postgresql-db-0
          kubectl -n $K8S_NAMESPACE logs pod/postgresql-db-0




