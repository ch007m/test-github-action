name: Create an IDP cluster

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  IDPBUILDER_VERSION: v0.4.1

  ARGOCD_VERSION: v0.10.0
  GITEA_VERSION: 1.22.0

  QUAY_ORG: snowdrop

jobs:
  idp-test:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && contains( github.event.head_commit.message, 'idp') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install idpbuilder
        run: |
          #version=$(curl -Ls -o /dev/null -w %{url_effective} https://github.com/cnoe-io/idpbuilder/releases/latest)
          #version=${version##*/}
          version=${IDPBUILDER_VERSION}
          curl -L -o ./idpbuilder.tar.gz "https://github.com/cnoe-io/idpbuilder/releases/download/${version}/idpbuilder-$(uname | awk '{print tolower($0)}')-$(uname -m | sed 's/x86_64/amd64/').tar.gz"
          tar xzf idpbuilder.tar.gz
          
          ./idpbuilder version
          
          sudo mv ./idpbuilder /usr/local/bin/

      - name: Create an IDP cluster
        run: |    
          idpbuilder create

      - name: Get credentials
        run: |
          idpbuilder get secrets